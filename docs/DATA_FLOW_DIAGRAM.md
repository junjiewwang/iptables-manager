# IPTables 五链四表数据流向图

## 数据包处理流程

```
                                    网络数据包
                                        ↓
                              ┌─────────────────┐
                              │   PREROUTING    │
                              │  ┌─────────────┐│
                              │  │    raw      ││  连接跟踪
                              │  ├─────────────┤│
                              │  │   mangle    ││  数据包标记
                              │  ├─────────────┤│
                              │  │    nat      ││  DNAT
                              │  └─────────────┘│
                              └─────────────────┘
                                        ↓
                                 ┌─────────────┐
                                 │  路由决策    │
                                 └─────────────┘
                                        ↓
                        ┌───────────────┴───────────────┐
                        ↓                               ↓
                ┌─────────────────┐              ┌─────────────────┐
                │     INPUT       │              │    FORWARD      │
                │  ┌─────────────┐│              │  ┌─────────────┐│
                │  │   mangle    ││              │  │   mangle    ││
                │  ├─────────────┤│              │  ├─────────────┤│
                │  │   filter    ││              │  │   filter    ││
                │  └─────────────┘│              │  └─────────────┘│
                └─────────────────┘              └─────────────────┘
                        ↓                               ↓
                ┌─────────────────┐                     ↓
                │   本地进程      │                     ↓
                └─────────────────┘                     ↓
                        ↓                               ↓
                ┌─────────────────┐                     ↓
                │     OUTPUT      │                     ↓
                │  ┌─────────────┐│                     ↓
                │  │    raw      ││                     ↓
                │  ├─────────────┤│                     ↓
                │  │   mangle    ││                     ↓
                │  ├─────────────┤│                     ↓
                │  │    nat      ││                     ↓
                │  ├─────────────┤│                     ↓
                │  │   filter    ││                     ↓
                │  └─────────────┘│                     ↓
                └─────────────────┘                     ↓
                        ↓                               ↓
                        └───────────────┬───────────────┘
                                        ↓
                              ┌─────────────────┐
                              │  POSTROUTING    │
                              │  ┌─────────────┐│
                              │  │   mangle    ││  最终修改
                              │  ├─────────────┤│
                              │  │    nat      ││  SNAT/MASQUERADE
                              │  └─────────────┘│
                              └─────────────────┘
                                        ↓
                                    发送到网络
```

## 表的优先级顺序

在每个链中，表的处理顺序是固定的：

1. **raw** - 连接跟踪处理
2. **mangle** - 数据包修改
3. **nat** - 网络地址转换
4. **filter** - 数据包过滤

## 网络接口关联

### 入接口 (Input Interface)
```
外部网络 → [eth0] → PREROUTING → 路由决策 → INPUT/FORWARD
```

### 出接口 (Output Interface)
```
FORWARD/OUTPUT → POSTROUTING → [eth1] → 外部网络
```

### 转发示例
```
[eth0] → PREROUTING → FORWARD → POSTROUTING → [eth1]
  ↑                                              ↓
外部网络A                                    外部网络B
```

## 实际应用场景

### 1. Web服务器配置
```
Internet → eth0 → PREROUTING(DNAT:80→8080) → INPUT(ACCEPT:8080) → Web服务
```

### 2. NAT网关配置
```
内网 → eth1 → FORWARD(ACCEPT) → POSTROUTING(MASQUERADE) → eth0 → Internet
```

### 3. Docker容器网络
```
容器 → docker0 → FORWARD(DOCKER规则) → POSTROUTING(MASQUERADE) → eth0 → Internet
```

## 可视化界面对应关系

### 链视图
- 水平展示上述流程中的五个链
- 每个链显示包含的表和规则数量
- 箭头指示数据流向

### 表视图
- 按表分组显示规则
- 显示每个表在不同链中的分布
- 突出显示表的主要功能

### 接口视图
- 显示网络接口与规则的关联
- 统计每个接口的输入/输出/转发规则
- 展示接口状态和配置信息